<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Student - Enhanced Wireframe v3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #2d3748;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
        }

        .header p {
            color: #4a5568;
            font-size: 14px;
            margin-top: 4px;
        }

        .form-body {
            padding: 24px;
        }

        .section {
            margin-bottom: 40px;
            padding-bottom: 24px;
        }

        .section:not(:last-child) {
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #cbd5e0;
            letter-spacing: -0.02em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            letter-spacing: 0.025em;
        }

        label.required::after {
            content: " *";
            color: #e53e3e;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }

        legend {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
            letter-spacing: 0.025em;
        }

        legend.required::after {
            content: " *";
            color: #e53e3e;
        }

        input, select, textarea {
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        input::placeholder,
        textarea::placeholder {
            color: #4a5568;
            opacity: 1;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .help-text {
            font-size: 12px;
            color: #4a5568;
            margin-top: 4px;
        }

        .help-text-inline {
            font-weight: 400;
            color: #4a5568;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Radio button styles */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-group.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            border-radius: 4px;
            transition: background 0.2s;
            min-height: 44px;
            min-width: 44px;
        }

        .radio-option:hover {
            background: #f7fafc;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            font-size: 14px;
        }

        /* Checkbox styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            margin-left: -8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .checkbox-group:hover {
            background: #f7fafc;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
        }

        /* Family search styles */
        .family-search-container {
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            pointer-events: none;
        }

        .search-input-wrapper input {
            padding-left: 40px;
        }

        .family-search-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .family-search-results.visible {
            display: block;
        }

        .result-section-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
        }

        .family-search-result {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }

        .family-search-result:hover {
            background: #f7fafc;
        }

        .family-search-result:last-child {
            border-bottom: none;
        }

        .family-search-result.create-new {
            color: #2c5282;
            font-weight: 600;
            background: #f7fafc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .family-search-result.create-new:hover {
            background: #ebf8ff;
        }

        .family-result-name {
            font-weight: 500;
            color: #1a202c;
        }

        .family-result-meta {
            font-size: 12px;
            color: #4a5568;
            margin-top: 2px;
        }

        .results-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        .selected-family {
            display: none;
            padding: 14px 16px;
            background: #ebf8ff;
            border: 2px solid #4299e1;
            border-radius: 8px;
        }

        .selected-family.visible {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-family-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .selected-icon {
            color: #2c5282;
            flex-shrink: 0;
        }

        .clear-selection {
            background: transparent;
            border: none;
            color: #4299e1;
            cursor: pointer;
            padding: 12px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .clear-selection:hover {
            background: rgba(66, 153, 225, 0.2);
            color: #2c5282;
        }

        .clear-selection:focus {
            outline: 2px solid #4299e1;
            outline-offset: 2px;
        }

        .toggle-section {
            margin: 24px 0;
            padding: 16px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px dashed #cbd5e0;
        }

        .toggle-button {
            background: white;
            border: 1px solid #cbd5e0;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #4299e1;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-button:hover {
            background: #ebf8ff;
            border-color: #4299e1;
        }

        .toggle-button:focus {
            outline: 2px solid #4299e1;
            outline-offset: 2px;
        }

        .hidden-fields {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: max-height 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
        }

        .hidden-fields.visible {
            max-height: 3000px;
            opacity: 1;
            transform: translateY(0);
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .family-creation {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #fef5e7;
            border-radius: 6px;
            border-left: 4px solid #f59e0b;
        }

        .family-creation.visible {
            display: block;
        }

        .family-creation-title {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
        }

        .actions {
            display: flex;
            gap: 12px;
            padding: 24px;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(49, 130, 206, 0.3);
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2c5282;
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:focus {
            outline: 2px solid #4299e1;
            outline-offset: 2px;
        }

        .btn-secondary {
            background: white;
            color: #718096;
            border: 1px solid #cbd5e0;
            font-weight: 400;
        }

        .btn-secondary:hover {
            background: #f7fafc;
        }

        .btn-secondary:focus {
            outline: 2px solid #cbd5e0;
            outline-offset: 2px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .success-modal.visible {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #22543d;
            margin-bottom: 12px;
        }

        .modal-content p {
            color: #4a5568;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            background: #fef5e7;
            color: #92400e;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 8px;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            .header {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
            }

            .modal-content {
                padding: 24px;
            }

            .modal-content h2 {
                font-size: 20px;
            }

            .modal-actions {
                flex-direction: column;
                width: 100%;
            }

            .modal-actions .btn {
                width: 100%;
            }

            .family-search-results {
                max-height: 50vh;
                position: fixed;
                left: 0;
                right: 0;
                top: auto;
                bottom: 0;
                border-radius: 12px 12px 0 0;
                box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
                margin-top: 0;
            }
        }

        .error {
            border-color: #fc8181 !important;
            background: #fff5f5;
        }

        .error-message {
            color: #c53030;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        input[aria-invalid="true"],
        select[aria-invalid="true"],
        textarea[aria-invalid="true"] {
            border-color: #fc8181;
            background: #fff5f5;
        }

        .keyboard-hint {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            font-size: 11px;
            font-weight: 400;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .keyboard-hint {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" role="banner">
            <h1>Add New Student</h1>
            <p>Create a student record with contact, academic, and billing information</p>
        </header>

        <form id="addStudentForm" onsubmit="submitForm(event); return false;" novalidate>
            <div class="form-body">
                <!-- Basic Information -->
                <section class="section">
                    <h2 class="section-title">Basic Information <span class="tag" role="status">All fields required</span></h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName" class="required">
                                First Name
                                <span class="sr-only">required</span>
                            </label>
                            <input
                                type="text"
                                id="firstName"
                                name="firstName"
                                autocomplete="given-name"
                                placeholder="Enter first name"
                                required
                                aria-required="true"
                                aria-describedby="firstNameError">
                            <span class="error-message" id="firstNameError" role="alert"></span>
                        </div>
                        <div class="form-group">
                            <label for="lastName" class="required">
                                Last Name
                                <span class="sr-only">required</span>
                            </label>
                            <input
                                type="text"
                                id="lastName"
                                name="lastName"
                                autocomplete="family-name"
                                placeholder="Enter last name"
                                required
                                aria-required="true"
                                aria-describedby="lastNameError">
                            <span class="error-message" id="lastNameError" role="alert"></span>
                        </div>
                    </div>

                    <div class="form-row single">
                        <fieldset>
                            <legend class="required">
                                Student Type
                                <span class="sr-only">required</span>
                            </legend>
                            <div class="radio-group horizontal" role="radiogroup" aria-required="true">
                                <div class="radio-option">
                                    <input
                                        type="radio"
                                        id="typeChild"
                                        name="studentType"
                                        value="child"
                                        checked
                                        aria-checked="true">
                                    <label for="typeChild">Child</label>
                                </div>
                                <div class="radio-option">
                                    <input
                                        type="radio"
                                        id="typeAdult"
                                        name="studentType"
                                        value="adult"
                                        aria-checked="false">
                                    <label for="typeAdult">Adult</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="form-row single">
                        <fieldset>
                            <legend class="required">
                                Status
                                <span class="sr-only">required</span>
                            </legend>
                            <div class="radio-group horizontal" role="radiogroup" aria-required="true">
                                <div class="radio-option">
                                    <input type="radio" id="statusActive" name="status" value="active" checked aria-checked="true">
                                    <label for="statusActive">Active</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusTrial" name="status" value="trial" aria-checked="false">
                                    <label for="statusTrial">Trial</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusWaiting" name="status" value="waiting" aria-checked="false">
                                    <label for="statusWaiting">Waiting</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusLead" name="status" value="lead" aria-checked="false">
                                    <label for="statusLead">Lead</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="statusInactive" name="status" value="inactive" aria-checked="false">
                                    <label for="statusInactive">Inactive</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label for="familySearch" class="required">
                                Family
                                <span class="sr-only">required</span>
                                <span class="help-text-inline">Search existing or create new</span>
                            </label>

                            <!-- Selected State -->
                            <div class="selected-family" id="selectedFamily" role="status" aria-live="polite">
                                <div class="selected-family-content">
                                    <svg class="selected-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                    </svg>
                                    <span id="selectedFamilyName"></span>
                                </div>
                                <button
                                    class="clear-selection"
                                    onclick="clearFamilySelection()"
                                    aria-label="Clear family selection"
                                    type="button">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Search State -->
                            <div class="family-search-container" id="familySearchContainer">
                                <div class="search-input-wrapper">
                                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
                                    </svg>
                                    <input
                                        type="text"
                                        id="familySearch"
                                        placeholder="Search families..."
                                        autocomplete="off"
                                        role="combobox"
                                        aria-expanded="false"
                                        aria-controls="familyResults"
                                        aria-autocomplete="list"
                                        aria-label="Search for existing family or create new family"
                                        aria-describedby="familyError"
                                        onfocus="showFamilyResults()"
                                        oninput="debouncedFilterFamilies(this.value)">
                                </div>

                                <div class="family-search-results" id="familyResults" role="listbox" aria-label="Family search results">
                                    <div class="result-section-header">Existing Families</div>
                                    <div class="family-search-result" role="option" tabindex="0" onclick="selectFamily('fam1', 'Smith Family', 3)" onkeydown="handleResultKeydown(event, 'fam1', 'Smith Family', 3)">
                                        <div class="family-result-name">Smith Family</div>
                                        <div class="family-result-meta">3 students</div>
                                    </div>
                                    <div class="family-search-result" role="option" tabindex="0" onclick="selectFamily('fam2', 'Johnson Family', 1)" onkeydown="handleResultKeydown(event, 'fam2', 'Johnson Family', 1)">
                                        <div class="family-result-name">Johnson Family</div>
                                        <div class="family-result-meta">1 student</div>
                                    </div>
                                    <div class="family-search-result" role="option" tabindex="0" onclick="selectFamily('fam3', 'Williams Family', 2)" onkeydown="handleResultKeydown(event, 'fam3', 'Williams Family', 2)">
                                        <div class="family-result-name">Williams Family</div>
                                        <div class="family-result-meta">2 students</div>
                                    </div>

                                    <div class="results-divider" role="separator"></div>

                                    <div class="family-search-result create-new" role="option" tabindex="0" onclick="selectCreateNew()" onkeydown="handleCreateNewKeydown(event)">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                        </svg>
                                        <span>Create New Family</span>
                                    </div>
                                </div>
                            </div>

                            <span class="error-message" id="familyError" role="alert"></span>
                        </div>
                    </div>

                    <!-- New Family Creation Section -->
                    <div class="family-creation" id="familyCreation" role="region" aria-label="New family information">
                        <div class="family-creation-title">Guardian Information (Required for New Family)</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="guardianFirstName" class="required">Guardian First Name</label>
                                <input
                                    type="text"
                                    id="guardianFirstName"
                                    autocomplete="given-name"
                                    placeholder="Enter guardian first name">
                            </div>
                            <div class="form-group">
                                <label for="guardianLastName" class="required">Guardian Last Name</label>
                                <input
                                    type="text"
                                    id="guardianLastName"
                                    autocomplete="family-name"
                                    placeholder="Enter guardian last name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="guardianEmail">Guardian Email</label>
                                <input
                                    type="email"
                                    id="guardianEmail"
                                    inputmode="email"
                                    autocomplete="email"
                                    placeholder="guardian@example.com">
                                <span class="help-text">Required: Email OR Phone Number</span>
                            </div>
                            <div class="form-group">
                                <label for="guardianPhone">Guardian Phone</label>
                                <input
                                    type="tel"
                                    id="guardianPhone"
                                    inputmode="tel"
                                    autocomplete="tel"
                                    placeholder="(555) 123-4567"
                                    oninput="formatPhoneNumber(this)">
                                <span class="help-text">Required: Email OR Phone Number</span>
                            </div>
                        </div>

                        <div class="form-row single">
                            <div class="checkbox-group">
                                <input type="checkbox" id="guardianSmsCapable" checked>
                                <label for="guardianSmsCapable">Guardian phone is SMS capable</label>
                            </div>
                        </div>

                        <div class="form-row single">
                            <div class="form-group">
                                <label for="guardianAddress">Guardian Address</label>
                                <input
                                    type="text"
                                    id="guardianAddress"
                                    autocomplete="street-address"
                                    placeholder="Street address">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="guardianCity">City</label>
                                <input
                                    type="text"
                                    id="guardianCity"
                                    autocomplete="address-level2"
                                    placeholder="City">
                            </div>
                            <div class="form-group">
                                <label for="guardianState">State</label>
                                <input
                                    type="text"
                                    id="guardianState"
                                    autocomplete="address-level1"
                                    placeholder="State">
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="guardianInvoiceRecipient" checked>
                            <label for="guardianInvoiceRecipient">Preferred Invoice Recipient</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="guardianShowPortal" checked>
                            <label for="guardianShowPortal">Show in Student Portal Contacts</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="guardianEmailReminders" checked>
                            <label for="guardianEmailReminders">Send Email Lesson Reminders</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="guardianSmsReminders" checked>
                            <label for="guardianSmsReminders">Send SMS Lesson Reminders</label>
                        </div>
                    </div>
                </section>

                <!-- Student Contact Information -->
                <section class="section">
                    <h2 class="section-title">Student Contact Information</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input
                                type="email"
                                id="email"
                                inputmode="email"
                                autocomplete="email"
                                placeholder="student@example.com"
                                aria-describedby="emailError">
                            <span class="error-message" id="emailError" role="alert"></span>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input
                                type="tel"
                                id="phone"
                                inputmode="tel"
                                autocomplete="tel"
                                placeholder="(555) 123-4567"
                                oninput="formatPhoneNumber(this)">
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="checkbox-group">
                            <input type="checkbox" id="smsCapable" checked>
                            <label for="smsCapable">Phone is SMS capable</label>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input
                                type="text"
                                id="address"
                                autocomplete="street-address"
                                placeholder="Street address">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input
                                type="text"
                                id="city"
                                autocomplete="address-level2"
                                placeholder="City">
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input
                                type="text"
                                id="state"
                                autocomplete="address-level1"
                                placeholder="State">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input
                                type="text"
                                id="zip"
                                inputmode="numeric"
                                autocomplete="postal-code"
                                placeholder="12345">
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input
                                type="text"
                                id="country"
                                autocomplete="country-name"
                                placeholder="Country"
                                value="United States">
                        </div>
                    </div>
                </section>

                <!-- Lesson Settings -->
                <section class="section">
                    <h2 class="section-title">Lesson Settings</h2>

                    <div class="form-row single">
                        <fieldset>
                            <legend>Lesson Category</legend>
                            <div class="radio-group horizontal" role="radiogroup">
                                <div class="radio-option">
                                    <input type="radio" id="catLesson" name="lessonCategory" value="lesson" checked aria-checked="true">
                                    <label for="catLesson">Lesson</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="catGroup" name="lessonCategory" value="group" aria-checked="false">
                                    <label for="catGroup">Group Lesson</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="catVacation" name="lessonCategory" value="vacation" aria-checked="false">
                                    <label for="catVacation">Vacation</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="duration">Default Duration (minutes)</label>
                            <input
                                type="number"
                                id="duration"
                                inputmode="numeric"
                                placeholder="30"
                                value="30"
                                min="0">
                        </div>
                        <div class="form-group">
                            <label for="billingType">Default Billing Type</label>
                            <select id="billingType">
                                <option value="">Select billing type...</option>
                                <option value="per-lesson">Per Lesson</option>
                                <option value="monthly">Monthly</option>
                                <option value="package">Package</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="price">Price</label>
                            <input
                                type="number"
                                id="price"
                                inputmode="decimal"
                                placeholder="0.00"
                                step="0.01"
                                min="0">
                        </div>
                        <div class="form-group">
                            <label for="priceType">Price Type</label>
                            <select id="priceType">
                                <option value="">Select price type...</option>
                                <option value="hourly">Hourly</option>
                                <option value="per-session">Per Session</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Notes -->
                <section class="section">
                    <h2 class="section-title">Notes</h2>
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="notes">Private Tutor Notes</label>
                            <textarea id="notes" placeholder="Add any private notes about this student..." aria-describedby="notesHelp"></textarea>
                            <span class="help-text" id="notesHelp">These notes are only visible to tutors</span>
                        </div>
                    </div>
                </section>

                <!-- Show More Fields Toggle -->
                <div class="toggle-section">
                    <button
                        class="toggle-button"
                        onclick="toggleAdditionalFields()"
                        aria-expanded="false"
                        aria-controls="additionalFields"
                        type="button">
                        <span id="toggleText">â–¼ Show More Fields</span>
                        <span class="keyboard-hint">Alt+M</span>
                    </button>

                    <div class="hidden-fields" id="additionalFields">
                        <!-- Personal Information -->
                        <section class="section">
                            <h2 class="section-title">Personal Information</h2>

                            <div class="form-row">
                                <fieldset>
                                    <legend>Gender</legend>
                                    <div class="radio-group" role="radiogroup">
                                        <div class="radio-option">
                                            <input type="radio" id="genderMale" name="gender" value="male">
                                            <label for="genderMale">Male</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="genderFemale" name="gender" value="female">
                                            <label for="genderFemale">Female</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="genderOther" name="gender" value="other">
                                            <label for="genderOther">Other</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="genderPreferNot" name="gender" value="prefer-not">
                                            <label for="genderPreferNot">Prefer not to say</label>
                                        </div>
                                    </div>
                                </fieldset>
                                <div class="form-group">
                                    <label for="birthday">Birthday</label>
                                    <input type="date" id="birthday">
                                </div>
                            </div>

                            <div class="form-row single">
                                <div class="form-group">
                                    <label for="school">School</label>
                                    <input type="text" id="school" placeholder="Start typing school name..." aria-describedby="schoolHelp">
                                    <span class="help-text" id="schoolHelp">Auto-complete enabled</span>
                                </div>
                            </div>
                        </section>

                        <!-- Academic Information -->
                        <section class="section">
                            <h2 class="section-title">Academic Information</h2>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="subjects">Subjects</label>
                                    <select id="subjects" multiple size="3" aria-describedby="subjectsHelp">
                                        <option value="math">Mathematics</option>
                                        <option value="science">Science</option>
                                        <option value="english">English</option>
                                        <option value="history">History</option>
                                        <option value="music">Music</option>
                                        <option value="art">Art</option>
                                    </select>
                                    <span class="help-text" id="subjectsHelp">Hold Ctrl/Cmd to select multiple</span>
                                </div>
                                <div class="form-group">
                                    <label for="skillLevel">Skill Level</label>
                                    <select id="skillLevel">
                                        <option value="">Select skill level...</option>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                            </div>
                        </section>

                        <!-- Communication Apps -->
                        <section class="section">
                            <h2 class="section-title">Communication Apps</h2>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="skype">Skype Username</label>
                                    <input type="text" id="skype" placeholder="skype.username">
                                </div>
                                <div class="form-group">
                                    <label for="facetime">FaceTime ID</label>
                                    <input type="text" id="facetime" placeholder="facetime@example.com">
                                </div>
                            </div>
                        </section>

                        <!-- Reminder Settings -->
                        <section class="section" id="reminderSettings">
                            <h2 class="section-title">Reminder Settings</h2>

                            <div class="checkbox-group">
                                <input type="checkbox" id="emailReminders" checked>
                                <label for="emailReminders">Send Email Lesson Reminders</label>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="smsReminders" checked>
                                <label for="smsReminders">Send SMS Lesson Reminders</label>
                            </div>
                        </section>

                        <!-- Other Information -->
                        <section class="section">
                            <h2 class="section-title">Other Information</h2>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="referrer">Referrer</label>
                                    <input type="text" id="referrer" placeholder="How did they find you?" aria-describedby="referrerHelp">
                                    <span class="help-text" id="referrerHelp">Previous referrers will auto-suggest</span>
                                </div>
                                <div class="form-group">
                                    <label for="studentSince">Student Since</label>
                                    <input type="date" id="studentSince">
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button
                    class="btn btn-secondary"
                    type="button"
                    onclick="handleCancel()"
                    aria-label="Cancel and return to previous page">
                    Cancel
                    <span class="keyboard-hint">Esc</span>
                </button>
                <button
                    class="btn btn-primary"
                    type="submit"
                    id="submitBtn"
                    aria-label="Create new student record">
                    Create Student
                    <span class="keyboard-hint">âŒ˜Enter</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content" role="document">
            <h2 id="modalTitle">âœ“ Student Added Successfully</h2>
            <p id="successMessage">Student "John Doe" has been added successfully.</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="window.location.reload()">Add Another Student</button>
                <button class="btn btn-secondary" onclick="closeModal()">Return to List</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFamilyId = null;

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedFilterFamilies = debounce(filterFamilies, 300);

        function toggleAdditionalFields() {
            const fields = document.getElementById('additionalFields');
            const toggleText = document.getElementById('toggleText');
            const button = document.querySelector('.toggle-button');

            if (fields.classList.contains('visible')) {
                fields.classList.remove('visible');
                toggleText.textContent = 'â–¼ Show More Fields';
                button.setAttribute('aria-expanded', 'false');
            } else {
                fields.classList.add('visible');
                toggleText.textContent = 'â–² Hide Additional Fields';
                button.setAttribute('aria-expanded', 'true');
            }
        }

        function showFamilyResults() {
            const results = document.getElementById('familyResults');
            const searchInput = document.getElementById('familySearch');
            results.classList.add('visible');
            searchInput.setAttribute('aria-expanded', 'true');
        }

        function hideFamilyResults() {
            setTimeout(() => {
                const results = document.getElementById('familyResults');
                const searchInput = document.getElementById('familySearch');
                results.classList.remove('visible');
                searchInput.setAttribute('aria-expanded', 'false');
            }, 200);
        }

        function filterFamilies(searchText) {
            const results = document.querySelectorAll('.family-search-result:not(.create-new)');
            const searchLower = searchText.toLowerCase();

            results.forEach(result => {
                const name = result.querySelector('.family-result-name').textContent.toLowerCase();
                if (name.includes(searchLower)) {
                    result.style.display = 'block';
                } else {
                    result.style.display = 'none';
                }
            });
        }

        function selectFamily(id, name, studentCount) {
            selectedFamilyId = id;
            document.getElementById('familySearchContainer').style.display = 'none';
            document.getElementById('selectedFamily').classList.add('visible');
            document.getElementById('selectedFamilyName').textContent = `${name} (${studentCount} students)`;
            document.getElementById('familyCreation').classList.remove('visible');
            document.getElementById('familySearch').setAttribute('aria-expanded', 'false');
        }

        function selectCreateNew() {
            selectedFamilyId = 'new';
            document.getElementById('familySearchContainer').style.display = 'none';
            document.getElementById('selectedFamily').classList.add('visible');
            document.getElementById('selectedFamilyName').textContent = 'New Family (will be created)';
            document.getElementById('familyCreation').classList.add('visible');
            document.getElementById('familySearch').setAttribute('aria-expanded', 'false');
        }

        function clearFamilySelection() {
            selectedFamilyId = null;
            document.getElementById('selectedFamily').classList.remove('visible');
            document.getElementById('familySearchContainer').style.display = 'block';
            document.getElementById('familyCreation').classList.remove('visible');
            document.getElementById('familySearch').value = '';
            document.getElementById('familySearch').focus();
        }

        function handleResultKeydown(event, id, name, count) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                selectFamily(id, name, count);
            }
        }

        function handleCreateNewKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                selectCreateNew();
            }
        }

        // Close results when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.family-search-container');
            if (searchContainer && !searchContainer.contains(event.target)) {
                hideFamilyResults();
            }
        });

        // Format phone number
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);

            if (value.length >= 6) {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                input.value = value;
            }
        }

        // Email validation
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Inline validation
        function setupInlineValidation() {
            // First name validation
            document.getElementById('firstName').addEventListener('blur', function() {
                const errorEl = document.getElementById('firstNameError');
                if (!this.value.trim()) {
                    this.setAttribute('aria-invalid', 'true');
                    this.classList.add('error');
                    errorEl.textContent = 'First name is required';
                    errorEl.classList.add('visible');
                } else {
                    this.removeAttribute('aria-invalid');
                    this.classList.remove('error');
                    errorEl.classList.remove('visible');
                }
            });

            // Last name validation
            document.getElementById('lastName').addEventListener('blur', function() {
                const errorEl = document.getElementById('lastNameError');
                if (!this.value.trim()) {
                    this.setAttribute('aria-invalid', 'true');
                    this.classList.add('error');
                    errorEl.textContent = 'Last name is required';
                    errorEl.classList.add('visible');
                } else {
                    this.removeAttribute('aria-invalid');
                    this.classList.remove('error');
                    errorEl.classList.remove('visible');
                }
            });

            // Email validation
            document.getElementById('email').addEventListener('blur', function() {
                const errorEl = document.getElementById('emailError');
                if (this.value && !validateEmail(this.value)) {
                    this.setAttribute('aria-invalid', 'true');
                    this.classList.add('error');
                    errorEl.textContent = 'Please enter a valid email address';
                    errorEl.classList.add('visible');
                } else {
                    this.removeAttribute('aria-invalid');
                    this.classList.remove('error');
                    errorEl.classList.remove('visible');
                }
            });

            // Clear errors on input
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('input', function() {
                    this.removeAttribute('aria-invalid');
                    this.classList.remove('error');
                    const errorId = this.getAttribute('aria-describedby');
                    if (errorId) {
                        const errorEl = document.getElementById(errorId);
                        if (errorEl && errorEl.classList.contains('error-message')) {
                            errorEl.classList.remove('visible');
                        }
                    }
                });
            });
        }

        function submitForm(event) {
            if (event) {
                event.preventDefault();
            }

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Creating Student...';

            // Clear previous errors
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('[aria-invalid]').forEach(el => el.removeAttribute('aria-invalid'));

            let hasErrors = false;

            // Validate required fields
            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            const firstNameError = document.getElementById('firstNameError');
            const lastNameError = document.getElementById('lastNameError');
            const familyError = document.getElementById('familyError');

            if (!firstName.value.trim()) {
                firstName.setAttribute('aria-invalid', 'true');
                firstName.classList.add('error');
                firstNameError.textContent = 'First name is required';
                firstNameError.classList.add('visible');
                hasErrors = true;
            }

            if (!lastName.value.trim()) {
                lastName.setAttribute('aria-invalid', 'true');
                lastName.classList.add('error');
                lastNameError.textContent = 'Last name is required';
                lastNameError.classList.add('visible');
                hasErrors = true;
            }

            if (!selectedFamilyId) {
                document.getElementById('familySearch').setAttribute('aria-invalid', 'true');
                document.getElementById('familySearch').classList.add('error');
                familyError.textContent = 'Family selection is required';
                familyError.classList.add('visible');
                hasErrors = true;
            }

            // Email validation
            const email = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            if (email.value && !validateEmail(email.value)) {
                email.setAttribute('aria-invalid', 'true');
                email.classList.add('error');
                emailError.textContent = 'Please enter a valid email address';
                emailError.classList.add('visible');
                hasErrors = true;
            }

            if (!hasErrors) {
                // Simulate API call
                setTimeout(() => {
                    const fullName = `${firstName.value} ${lastName.value}`;
                    document.getElementById('successMessage').textContent =
                        `Student "${fullName}" has been added successfully.`;
                    showModal();

                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalContent;
                }, 1500);
            } else {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;

                // Scroll to first error and focus
                const firstError = document.querySelector('.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
        }

        function handleCancel() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                window.history.back();
            }
        }

        function showModal() {
            const modal = document.getElementById('successModal');
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            window.modalPreviousFocus = document.activeElement;

            modal.classList.add('visible');
            firstFocusable.focus();

            // Focus trap
            function trapFocus(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                }

                if (e.key === 'Escape') {
                    closeModal();
                }
            }

            modal.addEventListener('keydown', trapFocus);
            window.modalTrapFunction = trapFocus;
        }

        function closeModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('visible');

            if (window.modalTrapFunction) {
                modal.removeEventListener('keydown', window.modalTrapFunction);
            }

            if (window.modalPreviousFocus) {
                window.modalPreviousFocus.focus();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('addStudentForm').requestSubmit();
            }

            // Escape to cancel (if no modal open)
            if (e.key === 'Escape' && !document.getElementById('successModal').classList.contains('visible')) {
                handleCancel();
            }

            // Alt + M to toggle more fields
            if (e.altKey && e.key === 'm') {
                e.preventDefault();
                toggleAdditionalFields();
            }
        });

        // Initialize
        window.onload = function() {
            document.getElementById('country').value = 'United States';
            document.getElementById('duration').value = '30';
            setupInlineValidation();
        }
    </script>
</body>
</html>
